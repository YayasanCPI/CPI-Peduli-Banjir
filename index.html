<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan & Aksi Solidaritas Banjir Sumatera</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyARoWTlJTd5eWIZP51QOhFihgOssAjz8R8",
            authDomain: "donasi-banjir.firebaseapp.com",
            projectId: "donasi-banjir",
            storageBucket: "donasi-banjir.firebasestorage.app",
            messagingSenderId: "407787434296",
            appId: "1:407787434296:web:85d491bab2ca3b9d4cd1cd"
        };

        let db, auth, docRef;
        let useLocalStorage = false;

        async function initApp() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                docRef = doc(db, 'campaigns', 'sumatera_2025');
                setupRealtimeListener();
            } catch (e) {
                console.warn("Mode Offline aktif.", e);
                useLocalStorage = true;
                loadFromLocal();
            }
        }

        function setupRealtimeListener() {
            onSnapshot(docRef, (snapshot) => {
                if (snapshot.exists()) {
                    updateUI(snapshot.data());
                } else {
                    initializeDB();
                }
            }, (error) => {
                if (!useLocalStorage) { useLocalStorage = true; loadFromLocal(); }
            });
        }

        async function initializeDB() {
            const initialData = {
                totalDonation: 154250000,
                messages: ["Doa terbaik untuk saudara di Sumatera.", "Semoga lekas pulih."],
                strategicPlan: [
                    { id: 1, activity: "Belanja Logistik", status: "Sedang Berjalan", statusColor: "bg-green-100 text-green-700", plan: "Sarden & Abon", actual: "Beras Cukup", next: "Packing" }
                ],
                fundAllocation: [
                    { id: 1, category: "Pangan Siap Saji", description: "Sarden, Abon, Susu", amount: 60000000 },
                    { id: 2, category: "Sandang & Hygiene", description: "Pakaian Dalam, Pembalut", amount: 40000000 },
                    { id: 3, category: "Logistik Kargo", description: "Pesawat JKT-Aceh", amount: 20000000 }
                ],
                gallery: [
                   { id: 1, url: 'https://images.unsplash.com/photo-1547638375-ebf04735d792?w=400', caption: 'Dapur Umum', date: '5 Des' },
                   { id: 2, url: 'https://images.unsplash.com/photo-1469571486292-0ba58a3f068b?w=400', caption: 'Evakuasi', date: '5 Des' }
                ]
            };
            
            if (!useLocalStorage) {
                await setDoc(docRef, initialData);
            } else {
                localStorage.setItem('flood_data', JSON.stringify(initialData));
                updateUI(initialData);
            }
        }

        // --- UPDATE FUNCTIONS ---
        window.saveDonationToBackend = async (total) => {
            if (!useLocalStorage) await updateDoc(docRef, { totalDonation: Number(total) });
            else { let d = getLocal(); d.totalDonation = Number(total); saveLocal(d); }
        };
        window.saveMessageToBackend = async (msg) => {
            if (!useLocalStorage) await updateDoc(docRef, { messages: arrayUnion(msg) });
            else { let d = getLocal(); d.messages.unshift(msg); saveLocal(d); }
        };
        window.saveDataToBackend = async (key, data) => { 
            try {
                if (!useLocalStorage) await updateDoc(docRef, { [key]: data });
                else { updateLocalData(key, data); }
                return true;
            } catch (error) {
                console.error("Gagal menyimpan:", error);
                if (error.code === 'resource-exhausted' || error.message.includes('exceeds the maximum allowed size')) {
                    alert("⚠️ PENYIMPANAN PENUH!\n\nDokumen database melebihi batas 1MB.\nSilakan hapus beberapa foto lama dari galeri sebelum menambah data baru.");
                } else {
                    alert("Gagal menyimpan data: " + error.message);
                }
                throw error;
            }
        };

        // --- LOCAL STORAGE HELPERS ---
        function getLocal() { return JSON.parse(localStorage.getItem('flood_data')) || {}; }
        function saveLocal(data) { localStorage.setItem('flood_data', JSON.stringify(data)); updateUI(data); }
        function loadFromLocal() { const d = getLocal(); d.totalDonation ? updateUI(d) : initializeDB(); }
        function updateLocalData(key, val) { const d = getLocal(); d[key] = val; saveLocal(d); }

        // --- RENDER FUNCTIONS ---
        function renderPlanTable(data) {
            const tableBody = document.getElementById('plan-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = data.map(item => `
                <tr class="border-b hover:bg-slate-50">
                    <td class="p-3">
                        <div class="font-bold text-slate-800">${item.activity}</div>
                        <span class="text-[10px] px-1.5 py-0.5 rounded ${item.statusColor}">${item.status}</span>
                    </td>
                    <td class="p-3 text-slate-600">${item.actual}</td>
                    <td class="p-3 text-blue-600 text-xs">${item.next}</td>
                </tr>
            `).join('');
        }

        function renderFundTable(data, totalIncome) {
            let totalExpense = 0;
            const colors = ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-orange-500', 'bg-pink-500'];
            
            const tableBody = document.getElementById('fund-table-body');
            if(!tableBody) return;

            tableBody.innerHTML = data.map((item, i) => {
                totalExpense += Number(item.amount);
                return `<tr class="border-b"><td class="p-3"><div class="font-bold text-slate-800">${item.category}</div><div class="text-xs text-slate-500">${item.description}</div></td><td class="p-3 text-right font-mono">${window.formatRupiah(item.amount)}</td></tr>`;
            }).join('');

            document.getElementById('total-expense').innerText = window.formatRupiah(totalExpense);
            const balance = totalIncome - totalExpense;
            document.getElementById('balance-amount').innerText = window.formatRupiah(balance);

            const barContainer = document.getElementById('fund-visual-bar');
            const legendContainer = document.getElementById('fund-legend');
            if(barContainer && legendContainer) {
                barContainer.innerHTML = ''; legendContainer.innerHTML = '';
                
                data.forEach((item, i) => {
                    const percent = (item.amount / totalIncome) * 100;
                    const color = colors[i % colors.length];
                    const segment = document.createElement('div');
                    segment.className = `${color} h-full`; segment.style.width = `${percent}%`;
                    barContainer.appendChild(segment);
                    legendContainer.innerHTML += `<div class="flex items-center gap-1 text-xs text-slate-600"><div class="w-3 h-3 rounded-full ${color}"></div><span>${item.category} (${Math.round(percent)}%)</span></div>`;
                });
                if(balance > 0) {
                    const percentBalance = (balance / totalIncome) * 100;
                    const segment = document.createElement('div');
                    segment.className = `bg-slate-200 h-full`; segment.style.width = `${percentBalance}%`;
                    barContainer.appendChild(segment);
                    legendContainer.innerHTML += `<div class="flex items-center gap-1 text-xs text-slate-600"><div class="w-3 h-3 rounded-full bg-slate-200"></div><span>Sisa (${Math.round(percentBalance)}%)</span></div>`;
                }
            }
        }

        function renderGallery(gallery) {
            const container = document.getElementById('gallery-carousel');
            if(!gallery || !container) return;
            container.innerHTML = gallery.map(photo => `
                <div class="gallery-item min-w-[280px] md:min-w-[350px] aspect-video relative rounded-lg overflow-hidden snap-center border bg-slate-200 break-inside-avoid">
                    <img src="${photo.url}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent flex flex-col justify-end p-3 pointer-events-none">
                        <p class="text-white text-xs font-bold">${photo.caption}</p>
                        <p class="text-slate-300 text-[10px]">${photo.date}</p>
                    </div>
                    <button onclick="window.deleteItem('gallery', ${gallery.indexOf(photo)})" class="absolute top-2 right-2 bg-red-600 text-white p-1 rounded-full opacity-50 hover:opacity-100 no-print pointer-events-auto"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function updateUI(data) {
            window.appState = data;
            
            let totalExpense = 0;
            if(data.fundAllocation) {
                totalExpense = data.fundAllocation.reduce((acc, item) => acc + Number(item.amount), 0);
            }

            if(data.totalDonation) {
                document.getElementById('total-amount-display').innerText = formatRupiah(data.totalDonation);
                document.getElementById('total-input').value = data.totalDonation;
                
                document.getElementById('used-display').innerText = formatRupiah(totalExpense);
                
                const remaining = data.totalDonation - totalExpense;
                document.getElementById('remaining-display').innerText = formatRupiah(remaining);

                const percent = Math.min((totalExpense / data.totalDonation) * 100, 100);
                document.getElementById('donation-bar').style.width = `${percent}%`;
                document.getElementById('donation-percent').innerText = `${Math.round(percent)}% Tersalurkan`;
            }
            
            if(data.messages) {
                const container = document.getElementById('marquee-container');
                if(container) {
                    const items = data.messages.map(msg => `
                        <span class="flex items-center gap-2 text-sm font-medium text-blue-200 mx-4">
                            <i data-lucide="heart" class="w-4 h-4 text-red-500 fill-red-500"></i> ${msg}
                        </span>
                    `).join('');
                    container.innerHTML = items + items;
                }
            }
            
            if(data.strategicPlan) renderPlanTable(data.strategicPlan);
            if(data.fundAllocation) renderFundTable(data.fundAllocation, data.totalDonation);
            if(data.gallery) renderGallery(data.gallery);
            
            lucide.createIcons();
        }

        window.formatRupiah = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
        
        window.deleteItem = (key, idx) => {
            if(confirm('Hapus item ini?')) {
                const arr = window.appState[key];
                arr.splice(idx, 1);
                window.saveDataToBackend(key, arr);
            }
        };

        initApp();
    </script>

    <!-- Custom Fonts & Print CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .animate-marquee { display: flex; animation: marquee 20s linear infinite; }
        
        .snap-x { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- PRINT STYLES --- */
        @media print {
            body { background: white !important; color: black !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .no-print, header button, .animate-marquee, form, .fixed, .sticky, button { display: none !important; }
            .container { max-width: 100% !important; padding: 0 !important; margin: 0 !important; }
            .bg-white, .shadow-lg, .rounded-xl { box-shadow: none !important; border: none !important; border-radius: 0 !important; }
            .bg-slate-50, .bg-green-50 { background-color: #f8fafc !important; }
            .text-white { color: black !important; }
            .bg-slate-900, .bg-blue-700, .bg-gradient-to-br { background: none !important; color: black !important; border-bottom: 2px solid #000; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            th, td { border: 1px solid #ddd; padding: 8px; }
            #gallery-carousel {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 15px !important;
                overflow: visible !important;
                padding: 0 !important;
            }
            .gallery-item {
                min-width: auto !important;
                aspect-ratio: auto !important;
                page-break-inside: avoid !important;
                border: 1px solid #eee !important;
            }
            .gallery-item img {
                max-width: 100% !important;
                height: auto !important;
                object-fit: contain !important;
            }
            .gallery-item .absolute {
                position: relative !important;
                background: none !important;
                color: black !important;
                padding: 5px !important;
            }
            .gallery-item p.text-white { color: black !important; font-weight: bold; }
            .gallery-item p.text-slate-300 { color: #666 !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex flex-col min-h-screen">

    <!-- RUNNING TEXT (No Print) -->
    <div class="bg-slate-900 text-white py-2 overflow-hidden relative z-20 shadow-md no-print">
        <div id="marquee-container" class="animate-marquee items-center gap-8 whitespace-nowrap pl-4"></div>
    </div>

    <!-- HEADER & FUND PROGRESS -->
    <header class="bg-gradient-to-br from-blue-700 to-slate-800 text-white pt-6 pb-24 px-4 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full opacity-10 no-print" style="background-image: url('https://www.transparenttextures.com/patterns/rain.png');"></div>
        <div class="max-w-4xl mx-auto relative z-10">
            <!-- Header Identity -->
            <div class="flex items-center gap-4 mb-6">
                <img src="https://i.ibb.co.com/KxWySDqp/logo-cpi.png" alt="Logo" class="w-16 h-16 rounded-full shadow-lg border-2 border-white">
                <div>
                    <h2 class="text-xl md:text-2xl font-bold">Yayasan Cakrawala Peduli Indonesia</h2>
                    <p class="text-blue-200 text-sm">Laporan Pertanggungjawaban Publik</p>
                </div>
                <button onclick="window.print()" class="ml-auto bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 no-print transition">
                    <i data-lucide="printer" class="w-4 h-4"></i> Cetak Laporan
                </button>
            </div>

            <div class="text-center mb-8">
                <div class="inline-flex items-center gap-2 bg-red-600 text-white px-4 py-1 rounded-full text-xs font-bold uppercase tracking-wider mb-4 animate-pulse no-print">
                    <i data-lucide="alert-triangle" class="w-4 h-4"></i> Status: Distribusi Tahap Akhir
                </div>
                <h1 class="text-3xl md:text-5xl font-extrabold mb-4 leading-tight">Aksi Solidaritas Banjir Sumatera</h1>
            </div>

            <!-- TOTAL & EXPENSE PROGRESS BAR CARD (REVISED FOR LARGER TEXT) -->
            <div class="bg-white/10 backdrop-blur-md border border-white/20 p-6 rounded-2xl max-w-2xl mx-auto">
                
                <!-- TOP ROW: Status Label & Used Amount -->
                <div class="flex justify-between items-end mb-4">
                    <span class="text-blue-200 text-sm font-bold uppercase tracking-wider">Status Dana</span>
                    <div class="text-right">
                        <span class="text-blue-200 text-xs font-bold uppercase tracking-wide block mb-1">Tersalurkan</span>
                        <span id="used-display" class="font-mono text-yellow-300 text-2xl font-bold">Rp 0</span>
                    </div>
                </div>
                
                <!-- MIDDLE: Total Donation (Smaller Context) -->
                <div class="flex items-center gap-3 mb-6 bg-slate-900/30 p-3 rounded-lg border border-white/10">
                    <div class="flex-grow">
                        <div class="text-xs text-blue-200">Total Donasi Terkumpul</div>
                        <div class="relative group">
                            <span id="total-amount-display" class="text-xl font-bold text-white font-mono">Rp 0</span>
                            <button onclick="toggleEditMode()" class="absolute -right-6 top-0 opacity-0 group-hover:opacity-100 text-white/50 hover:text-white no-print"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <!-- Hidden Edit Fields -->
                    <div id="edit-mode" class="hidden flex flex-col gap-2 bg-white p-2 rounded text-black absolute z-50 shadow-xl">
                        <label class="text-xs font-bold">Total Donasi:</label>
                        <input type="number" id="total-input" class="border p-1 rounded w-full">
                        <button onclick="saveDonation()" class="bg-green-600 text-white p-1 rounded text-sm w-full">Simpan</button>
                    </div>
                </div>

                <!-- PROGRESS BAR -->
                <div class="w-full bg-slate-900/50 rounded-full h-6 mb-3 overflow-hidden border border-white/10 relative">
                    <div id="donation-bar" class="bg-gradient-to-r from-green-400 to-emerald-600 h-6 rounded-full transition-all duration-1000 shadow-[0_0_15px_rgba(74,222,128,0.5)]" style="width: 0%"></div>
                </div>

                <!-- BOTTOM ROW: Percentage & Remaining Balance -->
                <div class="flex justify-between items-center mt-2">
                    <span class="text-green-300 text-xl md:text-2xl font-extrabold drop-shadow-md" id="donation-percent">0% Tersalurkan</span>
                    <div class="text-right">
                        <span class="text-blue-200 text-xs font-bold uppercase tracking-wide block mb-1">Sisa Saldo</span>
                        <span id="remaining-display" class="text-white text-xl font-mono font-bold bg-slate-800/50 px-2 py-1 rounded">Rp 0</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow container mx-auto px-4 py-8 max-w-5xl -mt-10 relative z-20">

        <!-- 1. EVIDEN CAROUSEL -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-3 px-2">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i data-lucide="camera" class="w-5 h-5 text-blue-600"></i> Dokumentasi Lapangan</h3>
                <label class="cursor-pointer text-blue-600 text-xs font-bold hover:underline no-print">
                    + Upload Foto
                    <input type="file" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                </label>
            </div>
            
            <div class="relative group">
                <div id="gallery-carousel" class="flex overflow-x-auto gap-4 py-2 snap-x scrollbar-hide scroll-smooth"></div>
                <button onclick="scrollGallery(-1)" class="absolute left-0 top-1/2 -translate-y-1/2 bg-white/80 p-2 rounded-full shadow-lg hover:bg-white hidden md:block no-print"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                <button onclick="scrollGallery(1)" class="absolute right-0 top-1/2 -translate-y-1/2 bg-white/80 p-2 rounded-full shadow-lg hover:bg-white hidden md:block no-print"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- LEFT CONTENT (2/3) -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- 2. STRATEGIC PLAN TABLE -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                        <h3 class="font-bold flex gap-2"><i data-lucide="map" class="w-5 h-5 text-blue-600"></i> Realisasi Rencana</h3>
                        <button onclick="toggleSection('plan-edit', 'plan-view')" class="text-xs text-blue-600 font-bold no-print">Edit Data</button>
                    </div>
                    <div id="plan-view" class="overflow-x-auto">
                        <table class="w-full text-sm text-left"><tbody id="plan-table-body" class="divide-y"></tbody></table>
                    </div>
                    <div id="plan-edit" class="hidden p-4 bg-slate-50 no-print">
                        <div id="plan-edit-container" class="space-y-2"></div>
                        <button onclick="addPlanItem()" class="mt-2 text-xs bg-white border px-2 py-1 rounded">+ Tambah</button>
                        <button onclick="savePlan()" class="mt-2 text-xs bg-blue-600 text-white px-3 py-1 rounded">Simpan</button>
                    </div>
                </div>

                <!-- 3. FUND ALLOCATION VISUAL & TABLE -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 bg-green-50 border-b flex justify-between items-center">
                        <h3 class="font-bold flex gap-2"><i data-lucide="pie-chart" class="w-5 h-5 text-green-600"></i> Transparansi Dana</h3>
                        <button onclick="toggleSection('fund-edit', 'fund-view')" class="text-xs text-green-600 font-bold no-print">Edit Data</button>
                    </div>
                    
                    <!-- Visual Progress Bar for Funds -->
                    <div class="px-6 pt-6 pb-2">
                         <div class="flex justify-between text-xs mb-1 text-slate-500 font-semibold">
                            <span>Komposisi Pengeluaran</span>
                            <span>Sisa Saldo</span>
                        </div>
                        <div class="w-full h-6 bg-slate-100 rounded-full overflow-hidden flex" id="fund-visual-bar"></div>
                        <div class="flex flex-wrap gap-3 mt-2" id="fund-legend"></div>
                    </div>

                    <div id="fund-view" class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500"><tr><th class="p-3">Item</th><th class="p-3 text-right">Nominal</th></tr></thead>
                            <tbody id="fund-table-body" class="divide-y"></tbody>
                            <tfoot class="bg-slate-50 font-bold">
                                <tr><td class="p-3 text-right">Total Terpakai</td><td class="p-3 text-right text-red-600" id="total-expense">0</td></tr>
                                <tr><td class="p-3 text-right">Sisa Saldo</td><td class="p-3 text-right text-green-600" id="balance-amount">0</td></tr>
                            </tfoot>
                        </table>
                    </div>
                    <div id="fund-edit" class="hidden p-4 bg-slate-50 no-print">
                        <div id="fund-edit-container" class="space-y-2"></div>
                        <button onclick="addFundItem()" class="mt-2 text-xs bg-white border px-2 py-1 rounded">+ Item</button>
                        <button onclick="saveFund()" class="mt-2 text-xs bg-green-600 text-white px-3 py-1 rounded">Simpan</button>
                    </div>
                </div>

            </div>

            <!-- RIGHT CONTENT (1/3) -->
            <div class="space-y-6">
                
                <!-- 4. FAQ SECTION -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                    <h3 class="font-bold mb-3 flex items-center gap-2"><i data-lucide="help-circle" class="w-5 h-5 text-purple-600"></i> Tanya Jawab (FAQ)</h3>
                    <div class="space-y-2">
                        <details class="group bg-slate-50 rounded-lg p-2 cursor-pointer">
                            <summary class="font-semibold text-sm list-none flex justify-between items-center">
                                Masih terima donasi barang?
                                <i data-lucide="chevron-down" class="w-4 h-4 group-open:rotate-180 transition"></i>
                            </summary>
                            <p class="text-xs text-slate-600 mt-2 leading-relaxed">Saat ini kami fokus mendistribusikan stok yang ada. Penerimaan barang dihentikan sementara untuk efisiensi logistik kargo.</p>
                        </details>
                        <details class="group bg-slate-50 rounded-lg p-2 cursor-pointer">
                            <summary class="font-semibold text-sm list-none flex justify-between items-center">
                                Dimana posko utamanya?
                                <i data-lucide="chevron-down" class="w-4 h-4 group-open:rotate-180 transition"></i>
                            </summary>
                            <p class="text-xs text-slate-600 mt-2 leading-relaxed">Posko utama di FISIP Universitas Syiah Kuala, Banda Aceh. Kontak Koord Lapangan: 0852-2802-9800.</p>
                        </details>
                        <details class="group bg-slate-50 rounded-lg p-2 cursor-pointer">
                            <summary class="font-semibold text-sm list-none flex justify-between items-center">
                                Kapan laporan final rilis?
                                <i data-lucide="chevron-down" class="w-4 h-4 group-open:rotate-180 transition"></i>
                            </summary>
                            <p class="text-xs text-slate-600 mt-2 leading-relaxed">Laporan final akan dirilis di halaman ini 3 hari setelah seluruh dana tersalurkan (Estimasi 10 Desember).</p>
                        </details>
                    </div>
                </div>

                <!-- SEND MESSAGE -->
                <div class="bg-white p-4 rounded-xl border border-blue-100 shadow-sm no-print">
                    <h3 class="font-bold text-sm mb-2">Kirim Pesan Semangat</h3>
                    <form onsubmit="handleSendMessage(event)" class="flex gap-2">
                        <input type="text" id="msg-input" placeholder="Tulis doa..." class="w-full border p-2 rounded text-sm" required>
                        <button class="bg-blue-600 text-white p-2 rounded"><i data-lucide="send" class="w-4 h-4"></i></button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- 5. FLOATING SHARE BUTTONS & FOOTER -->
    <div class="fixed bottom-0 left-0 w-full bg-white border-t p-3 flex justify-between items-center z-50 no-print shadow-[0_-5px_15px_rgba(0,0,0,0.1)]">
        <div class="text-xs font-bold text-slate-500 hidden md:block">Bantu sebarkan transparansi ini:</div>
        <div class="flex gap-2 w-full md:w-auto justify-center">
            <button onclick="shareSocial('wa')" class="flex-1 md:flex-none bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-2">
                <i data-lucide="message-circle" class="w-4 h-4"></i> WhatsApp
            </button>
            <button onclick="shareSocial('fb')" class="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-2">
                <i data-lucide="facebook" class="w-4 h-4"></i> Facebook
            </button>
            <button onclick="window.print()" class="flex-1 md:flex-none bg-slate-800 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-2">
                <i data-lucide="printer" class="w-4 h-4"></i> Print
            </button>
        </div>
    </div>

    <div class="h-16"></div>

    <!-- MODAL CAPTION -->
    <div id="caption-modal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg w-full max-w-sm shadow-2xl">
            <h4 class="font-bold mb-2">Keterangan Foto</h4>
            <input type="text" id="temp-caption" class="w-full border p-2 rounded mb-4 text-sm">
            <div class="flex justify-end gap-2">
                <button onclick="cancelUpload()" class="px-4 py-2 text-sm">Batal</button>
                <button onclick="confirmUpload()" class="px-4 py-2 bg-blue-600 text-white rounded text-sm">Upload</button>
            </div>
        </div>
    </div>

    <!-- LOGIC SCRIPT -->
    <script>
        function toggleSection(editId, viewId) {
            const edit = document.getElementById(editId), view = document.getElementById(viewId);
            const isEditing = !edit.classList.contains('hidden');
            if(isEditing) { edit.classList.add('hidden'); view.classList.remove('hidden'); }
            else { 
                edit.classList.remove('hidden'); view.classList.add('hidden'); 
                if(editId === 'plan-edit') renderPlanEditInputs();
                if(editId === 'fund-edit') renderFundEditInputs();
            }
        }
        function toggleEditMode() { document.getElementById('edit-mode').classList.toggle('hidden'); }
        function saveDonation() {
            const total = document.getElementById('total-input').value;
            window.saveDonationToBackend(total);
            toggleEditMode();
        }
        function handleSendMessage(e) {
            e.preventDefault();
            const val = document.getElementById('msg-input').value.trim();
            if(val) { window.saveMessageToBackend(`Dukungan: ${val}`); document.getElementById('msg-input').value = ''; alert('Pesan terkirim!'); }
        }
        function shareSocial(type) {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent("Alhamdulillah, donasi banjir Sumatera sudah tersalurkan. Cek laporan transparansinya di sini:");
            if(type === 'wa') window.open(`https://wa.me/?text=${text}%20${url}`);
            if(type === 'fb') window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`);
        }
        function scrollGallery(dir) { document.getElementById('gallery-carousel').scrollBy({ left: dir * 300, behavior: 'smooth' }); }

        // EDITS
        function renderPlanEditInputs() {
            const plan = window.appState.strategicPlan || [];
            document.getElementById('plan-edit-container').innerHTML = plan.map((item, i) => `
                <div class="bg-white p-3 border rounded relative text-xs">
                    <button onclick="window.deleteItem('strategicPlan', ${i})" class="absolute top-2 right-2 text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    <div class="grid gap-2">
                        <input id="pa-${i}" value="${item.activity}" class="border-b font-bold" placeholder="Kegiatan">
                        <select id="ps-${i}" class="border-b"><option value="Selesai" ${item.status==='Selesai'?'selected':''}>Selesai</option><option value="Proses" ${item.status==='Proses'?'selected':''}>Proses</option></select>
                        <input id="pp-${i}" value="${item.plan}" class="border-b" placeholder="Rencana">
                        <input id="pac-${i}" value="${item.actual}" class="border-b" placeholder="Aktual">
                        <input id="pn-${i}" value="${item.next}" class="border-b" placeholder="Next">
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }
        function renderFundEditInputs() {
            const fund = window.appState.fundAllocation || [];
            document.getElementById('fund-edit-container').innerHTML = fund.map((item, i) => `
                <div class="bg-white p-3 border rounded relative text-xs">
                    <button onclick="window.deleteItem('fundAllocation', ${i})" class="absolute top-2 right-2 text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    <div class="grid gap-2">
                        <input id="fc-${i}" value="${item.category}" class="border-b font-bold" placeholder="Kategori">
                        <input id="fd-${i}" value="${item.description}" class="border-b" placeholder="Deskripsi">
                        <input type="number" id="fa-${i}" value="${item.amount}" class="border-b font-mono" placeholder="Nominal">
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }
        function savePlan() {
            const newPlan = window.appState.strategicPlan.map((old, i) => ({
                ...old,
                activity: document.getElementById(`pa-${i}`).value,
                status: document.getElementById(`ps-${i}`).value,
                statusColor: document.getElementById(`ps-${i}`).value === 'Selesai' ? 'bg-slate-200 text-slate-500' : 'bg-green-100 text-green-700',
                plan: document.getElementById(`pp-${i}`).value,
                actual: document.getElementById(`pac-${i}`).value,
                next: document.getElementById(`pn-${i}`).value
            }));
            window.saveDataToBackend('strategicPlan', newPlan);
            toggleSection('plan-edit', 'plan-view');
        }
        function saveFund() {
            const newFund = window.appState.fundAllocation.map((old, i) => ({
                ...old,
                category: document.getElementById(`fc-${i}`).value,
                description: document.getElementById(`fd-${i}`).value,
                amount: Number(document.getElementById(`fa-${i}`).value)
            }));
            window.saveDataToBackend('fundAllocation', newFund);
            toggleSection('fund-edit', 'fund-view');
        }
        function addPlanItem() {
            // Capture existing inputs first
            const plans = window.appState.strategicPlan || [];
            const currentPlan = plans.map((item, i) => ({
                ...item,
                activity: document.getElementById(`pa-${i}`) ? document.getElementById(`pa-${i}`).value : item.activity,
                status: document.getElementById(`ps-${i}`) ? document.getElementById(`ps-${i}`).value : item.status,
                plan: document.getElementById(`pp-${i}`) ? document.getElementById(`pp-${i}`).value : item.plan,
                actual: document.getElementById(`pac-${i}`) ? document.getElementById(`pac-${i}`).value : item.actual,
                next: document.getElementById(`pn-${i}`) ? document.getElementById(`pn-${i}`).value : item.next
            }));
            currentPlan.push({id:Date.now(), activity:"", status:"Proses", plan:"", actual:"", next:""});
            window.appState.strategicPlan = currentPlan;
            renderPlanEditInputs();
        }

        function addFundItem() {
            // Capture existing inputs first
            const funds = window.appState.fundAllocation || [];
            const currentFund = funds.map((item, i) => ({
                ...item,
                category: document.getElementById(`fc-${i}`) ? document.getElementById(`fc-${i}`).value : item.category,
                description: document.getElementById(`fd-${i}`) ? document.getElementById(`fd-${i}`).value : item.description,
                amount: document.getElementById(`fa-${i}`) ? Number(document.getElementById(`fa-${i}`).value) : item.amount
            }));
            currentFund.push({id:Date.now(), category:"", description:"", amount:0});
            window.appState.fundAllocation = currentFund;
            renderFundEditInputs();
        }
        
        let tempImageBase64 = null;
        function handleImageUpload(e) {
            const file = e.target.files[0]; if (!file) return;
            document.getElementById('caption-modal').classList.remove('hidden');
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image(); img.src = ev.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas'), ctx = canvas.getContext('2d');
                    const scale = 400 / img.width; canvas.width = 400; canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    tempImageBase64 = canvas.toDataURL('image/jpeg', 0.5);
                };
            };
            reader.readAsDataURL(file);
        }
        function confirmUpload() {
            if(tempImageBase64) {
                const caption = document.getElementById('temp-caption').value || "Dokumentasi";
                const newImg = { id: Date.now(), url: tempImageBase64, caption, date: new Date().toLocaleDateString('id-ID') };
                const arr = window.appState.gallery || []; arr.unshift(newImg);
                window.saveDataToBackend('gallery', arr)
                    .then(cancelUpload)
                    .catch(error => {
                        console.error(error);
                        if (error.code === 'resource-exhausted' || error.message.includes('exceeds the maximum allowed size')) {
                            alert("Gagal upload: Penyimpanan penuh. Mohon hapus beberapa foto lama atau upload foto dengan ukuran lebih kecil.");
                        } else {
                            alert("Gagal upload: " + error.message);
                        }
                    });
            }
        }
        function cancelUpload() { document.getElementById('caption-modal').classList.add('hidden'); tempImageBase64 = null; }

        document.addEventListener('DOMContentLoaded', () => { lucide.createIcons(); });
    </script>
</body>
</html>
